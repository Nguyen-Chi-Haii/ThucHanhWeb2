@model IEnumerable<LibraryMVCWeb.Models.DTO.BookDTO>

@{
    ViewData["Title"] = "Danh Sách Sách";
}

<h1>Danh Sách Sách</h1>

<p>
    <a class="btn btn-success mb-3" asp-action="addBook">Thêm Sách Mới</a>
</p>

<form asp-controller="Book" asp-action="Index" method="GET" class="border p-3 mb-4 bg-light rounded">

    <h4 class="mb-3">Bộ Lọc & Sắp Xếp</h4>

    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="filterOn" class="form-label">Lọc theo:</label>
            <select name="filterOn" id="filterOn" class="form-control">
                <option value="title" selected="@(ViewBag.FilterOn == "title")">Tiêu đề</option>
                <option value="author" selected="@(ViewBag.FilterOn == "author")">Tác giả</option>
                <option value="publisher" selected="@(ViewBag.FilterOn == "publisher")">Nhà xuất bản</option>
            </select>

        </div>

        <div class="col-md-4">
            <label for="filterQuery" class="form-label">Từ khóa:</label>
            <input type="text" name="filterQuery" class="form-control" placeholder="Nhập từ khóa..." value="@ViewBag.FilterQuery" />
        </div>

        <div class="col-md-2">
            <label for="sortBy" class="form-label">Sắp xếp theo:</label>
            <select name="sortBy" id="sortBy" class="form-control">
                <option value="title" selected=@(ViewBag.SortBy == "title" ? "selected" : "")>Tiêu đề</option>
                <option value="rate" selected=@(ViewBag.SortBy == "rate" ? "selected" : "")>Đánh giá</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label d-block">Thứ tự:</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="isAscending" id="sortAsc" value="True" @(ViewBag.IsAscending ? "checked" : "")>
                <label class="form-check-label" for="sortAsc">Tăng dần</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="isAscending" id="sortDesc" value="False" @(!ViewBag.IsAscending ? "checked" : "")>
                <label class="form-check-label" for="sortDesc">Giảm dần</label>
            </div>
        </div>
    </div>

    <div class="text-end mt-3">
        <input type="submit" value="Tìm Kiếm & Sắp Xếp" class="btn btn-primary me-2" />
        <a asp-action="Index" class="btn btn-secondary">Đặt Lại</a>
    </div>

</form>


<hr />

<h2>Kết Quả</h2>
@if (Model != null && Model.Any())
{
    <table class="table table-striped table-bordered table-hover mt-3">
        <thead class="table-dark">
            <tr>
                <th>STT</th>
                <th>Ảnh bìa</th>
                <th>Tiêu đề</th>
                <th>Mô tả</th>
                <th>Thể loại</th>
                <th>Nhà xuất bản</th>
                <th>Tác giả</th>
                <th>Đã đọc</th>
                <th>Ngày đọc</th>
                <th>Đánh giá</th>
                <th>Ngày thêm</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var (book, index) in Model.Select((b, i) => (b, i + 1)))
            {
                <tr>
                    <td>@index</td>
                    <td>
                        @if (!string.IsNullOrEmpty(book.CoverUrl))
                        {
                            <img src="@book.CoverUrl" alt="Cover" width="60" height="90" style="object-fit:cover; border-radius:5px;" />
                        }
                        else
                        {
                            <span class="text-muted">Không có ảnh</span>
                        }
                    </td>
                    <td>@book.Title</td>
                    <td>@(book.Description?.Length > 50 ? book.Description.Substring(0, 50) + "..." : book.Description)</td>
                    <td>@book.Genre</td>
                    <td>@book.PublisherName</td>
                    <td>
                        @if (book.AuthorNames != null && book.AuthorNames.Any())
                        {
                            @string.Join(", ", book.AuthorNames)
                        }
                        else
                        {
                            <span class="text-muted">Chưa có</span>
                        }
                    </td>
                    <td>
                        @(book.IsRead ? "✔️" : "❌")
                    </td>
                    <td>
                        @(book.DateRead?.ToString("dd/MM/yyyy") ?? "-")
                    </td>
                    <td>
                        @if (book.Rate.HasValue)
                        {
                            @($"{book.Rate}/10")
                        }
                        else
                        {
                            <span class="text-muted">Chưa đánh giá</span>
                        }
                    </td>
                    <td>@book.DateAdded.ToString("dd/MM/yyyy")</td>
                    <td>
                        <button type="button"
                                class="btn btn-info btn-sm text-white"
                                onclick="showBookDetail('@book.Id')">
                            <i class="bi bi-eye"></i> Chi tiết
                        </button>
                        <a asp-action="EditBook" asp-route-id="@book.Id" class="btn btn-warning btn-sm">✏️ Sửa</a>

                        <form asp-action="DeleteBook" asp-route-id="@book.Id" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger btn-sm"
                                    onclick="return confirm('Bạn có chắc muốn xóa sách này không?')">
                                🗑️ Xóa
                            </button>
                        </form>
                    </td>


                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info mt-3">
        Không có sách nào được tìm thấy.
    </div>
}
<!-- Modal Chi tiết sách -->
<div class="modal fade" id="bookDetailModal" tabindex="-1" aria-labelledby="bookDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="bookDetailLabel">Chi tiết sách</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div id="bookDetailContent">
                    <p class="text-muted">Chưa có dữ liệu.</p>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        async function showBookDetail(bookId) {
            const modal = new bootstrap.Modal(document.getElementById('bookDetailModal'));
            const content = document.getElementById('bookDetailContent');
            content.innerHTML = `<p class="text-muted">🔄 Đang tải dữ liệu...</p>`;
            modal.show();

            try {
                const response = await fetch(`/Book/GetBookDetail/${bookId}`);
                if (!response.ok) {
                    content.innerHTML = `<div class="alert alert-danger">Không thể tải thông tin sách.</div>`;
                    return;
                }

                const book = await response.json();

                content.innerHTML = `
                    <div class="container">
                        <div class="row">
                            <div class="col-md-4">
                                <img src="${book.coverUrl || '/images/no-cover.png'}"
                                     alt="Bìa sách"
                                     class="img-fluid rounded shadow-sm mb-3" />
                            </div>
                            <div class="col-md-8">
                                <h5>${book.title || "Không có tiêu đề"}</h5>
                                <p><strong>Tác giả:</strong> ${(book.authorNames || []).join(", ")}</p>
                                <p><strong>Nhà xuất bản:</strong> ${book.publisherName || "N/A"}</p>
                                <p><strong>Thể loại:</strong> ${book.genre || "N/A"}</p>
                                <p><strong>Đánh giá:</strong> ${book.rate ?? "Chưa có"}</p>
                                <p><strong>Ngày thêm:</strong> ${book.dateAdded ? new Date(book.dateAdded).toLocaleDateString() : "N/A"}</p>
                                <p><strong>Mô tả:</strong><br>${book.description || "Không có mô tả"}</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                content.innerHTML = `<div class="alert alert-danger">Lỗi khi tải dữ liệu: ${err.message}</div>`;
            }
        }
    </script>
}

